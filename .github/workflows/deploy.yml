name: Deploy to Production

# ==============================================================================
# Triggers
# ==============================================================================
on:
  push:
    # Trigger only when a tag starting with 'v' is pushed (e.g., v1.0.0, v2.1.0)
    # This ensures deployment only happens for official releases.
    tags:
      - 'v*'
  # Allow manual triggering of the workflow from GitHub Actions UI
  workflow_dispatch:

# ==============================================================================
# Environment Variables
# ==============================================================================
env:
  REGISTRY: ghcr.io # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }} # The name of the repository (user/repo)

jobs:
  # ==============================================================================
  # Job 1: Build and Push Docker Image
  # Purpose: Build the Docker image from the Dockerfile and push it to the registry.
  # ==============================================================================
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Read access to the repository
      packages: write # Write access to upload packages/images

    steps:
      # Step 1: Checkout the code from the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Log in to the Container Registry (GHCR)
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Automatically provided by GitHub

      # Step 3: Extract metadata (tags, labels) for the Docker image
      # This handles versioning based on the git tag (e.g., v1.0.0 -> image:1.0.0)
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest

      # Step 4: Build the image using the Dockerfile and push it to the registry
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: Dockerfile 

  # ==============================================================================
  # Job 2: Deploy to Server
  # Purpose: Connect to the production server and update the running application.
  # This runs ONLY if the build-and-push-image job succeeds.
  # ==============================================================================
  deploy-to-server:
    runs-on: ubuntu-latest
    needs: build-and-push-image # Dependency: Wait for build job
    if: success() 
    
    steps:
      # Step 1: SSH into the server and execute deployment commands
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Secrets must be configured in GitHub Repository Settings -> Secrets and variables
          host: ${{ secrets.SERVER_HOST }}     # IP address of your VPS
          username: ${{ secrets.SERVER_USER }} # SSH username (e.g., root or ubuntu)
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # Private SSH key content
          script: |
            # Navigate to the application directory on the server
            cd /var/www/invent-mag
            
            # Pull the latest Docker image that was just built and pushed
            docker-compose pull
            
            # Restart the services (app, webserver, queue) with the new image
            # -d means detached mode (run in background)
            docker-compose up -d
            
            # Run database migrations
            # --force is needed in production to bypass confirmation prompt
            docker-compose exec -T app php artisan migrate --force
            
            # Clear and recache configuration, routes, and views for performance
            docker-compose exec -T app php artisan optimize:clear
            docker-compose exec -T app php artisan config:cache
            docker-compose exec -T app php artisan route:cache
            docker-compose exec -T app php artisan view:cache
